# ä¿®æ”¹å¾Œçš„è³¼è²·å„²å‚™æµç¨‹åˆ†æå ±å‘Š

## ğŸ”„ ä¸»è¦ä¿®æ”¹å…§å®¹

### åŸå§‹è¨­è¨ˆ vs æ–°è¨­è¨ˆ

| æ–¹é¢ | åŸå§‹è¨­è¨ˆ | æ–°è¨­è¨ˆ |
|------|----------|--------|
| **æ‰£æ¬¾ä¾†æº** | PlayerVaulté‡‘åº« | ç”¨æˆ¶éŒ¢åŒ…ç›´æ¥æ‰£æ¬¾ |
| **æˆæ¬Šéœ€æ±‚** | éœ€è¦å…ˆå­˜éŒ¢åˆ°é‡‘åº« | éœ€è¦æˆæ¬Šåˆç´„ä½¿ç”¨ä»£å¹£ |
| **äº¤æ˜“è¤‡é›œåº¦** | éœ€è¦å…©æ­¥ï¼šå……å€¼+è³¼è²· | ä¸€æ­¥å®Œæˆè³¼è²· |
| **ç”¨æˆ¶é«”é©—** | è¼ƒè¤‡é›œ | æ›´ç›´è§€ç°¡å–® |

## ğŸ“ ä¿®æ”¹å¾Œçš„è³¼è²·å„²å‚™æµç¨‹

### æ ¸å¿ƒå‡½æ•¸ï¼šä¿®æ”¹å¾Œçš„ `buyProvisions()`

```solidity
function buyProvisions(uint256 _partyId, uint256 _amount) 
    external nonReentrant whenNotPaused onlyPartyOwner(_partyId)
{
    require(_amount > 0, "DM: Amount must be > 0");
    require(address(dungeonCore) != address(0), "DM: DungeonCore not set");

    // è¨ˆç®—ç¸½æˆæœ¬
    uint256 totalCostUSD = provisionPriceUSD * _amount;
    uint256 requiredSoulShard = dungeonCore.getSoulShardAmountForUSD(totalCostUSD);
    
    // ç²å–SoulShardä»£å¹£åˆç´„åœ°å€
    address soulShardToken = dungeonCore.soulShardTokenAddress();
    require(soulShardToken != address(0), "DM: SoulShard token not set");
    
    // æª¢æŸ¥ç”¨æˆ¶é¤˜é¡æ˜¯å¦è¶³å¤ 
    IERC20 soulShard = IERC20(soulShardToken);
    require(soulShard.balanceOf(msg.sender) >= requiredSoulShard, "DM: Insufficient SoulShard balance");
    
    // ç›´æ¥å¾ç”¨æˆ¶éŒ¢åŒ…è½‰è³¬SoulShardåˆ°åˆç´„
    soulShard.safeTransferFrom(msg.sender, address(this), requiredSoulShard);
    
    // æ›´æ–°éšŠä¼å„²å‚™ç‹€æ…‹
    IDungeonStorage.PartyStatus memory status = dungeonStorage.getPartyStatus(_partyId);
    status.provisionsRemaining += _amount;
    dungeonStorage.setPartyStatus(_partyId, status);

    emit ProvisionsBought(_partyId, _amount, requiredSoulShard);
}
```

### æ–°çš„æµç¨‹æ­¥é©Ÿ

1. **å‰ç½®æº–å‚™**
   - ç”¨æˆ¶éœ€è¦æŒæœ‰è¶³å¤ çš„SoulShardä»£å¹£
   - ç”¨æˆ¶éœ€è¦æˆæ¬ŠDungeonMasteråˆç´„ä½¿ç”¨å…¶SoulShardä»£å¹£

2. **æ¬Šé™é©—è­‰**
   - æª¢æŸ¥èª¿ç”¨è€…æ˜¯å¦ç‚ºéšŠä¼æ“æœ‰è€…
   - æª¢æŸ¥åˆç´„æ˜¯å¦æš«åœ
   - é˜²é‡å…¥æ”»æ“Šæª¢æŸ¥

3. **æˆæœ¬è¨ˆç®—**
   - è¨ˆç®—USDç¸½æˆæœ¬
   - é€šéOracleè½‰æ›ç‚ºSoulShardæ•¸é‡

4. **é¤˜é¡æª¢æŸ¥**
   - é©—è­‰ç”¨æˆ¶éŒ¢åŒ…ä¸­SoulShardé¤˜é¡æ˜¯å¦è¶³å¤ 

5. **ç›´æ¥æ‰£æ¬¾**
   - ä½¿ç”¨`safeTransferFrom`å¾ç”¨æˆ¶éŒ¢åŒ…è½‰è³¬åˆ°åˆç´„
   - ç„¡éœ€ç¶“éPlayerVault

6. **ç‹€æ…‹æ›´æ–°**
   - å¢åŠ éšŠä¼å„²å‚™æ•¸é‡
   - ç™¼å‡ºäº‹ä»¶

## ğŸ”§ ç›¸é—œä¿®æ”¹å…§å®¹

### 1. DungeonMaster.sol åˆç´„ä¿®æ”¹

#### æ·»åŠ çš„å°å…¥
```solidity
import "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import "@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol";
```

#### æ·»åŠ çš„ç‹€æ…‹è²æ˜
```solidity
using SafeERC20 for IERC20;
```

#### ä¿®æ”¹çš„å‡½æ•¸
- `buyProvisions()` - æ”¹ç‚ºå¾ç”¨æˆ¶éŒ¢åŒ…ç›´æ¥æ‰£æ¬¾
- `restParty()` - åŒæ¨£æ”¹ç‚ºå¾ç”¨æˆ¶éŒ¢åŒ…ç›´æ¥æ‰£æ¬¾

#### æ–°å¢çš„ç®¡ç†å‡½æ•¸
```solidity
function withdrawSoulShardTokens(uint256 _amount) external onlyOwner {
    // å…è¨±ç®¡ç†å“¡æå–åˆç´„ä¸­æ”¶é›†åˆ°çš„SoulShardä»£å¹£
}
```

### 2. interfaces.sol æ¥å£ä¿®æ”¹

#### åœ¨ IDungeonCore æ¥å£ä¸­æ·»åŠ 
```solidity
function soulShardTokenAddress() external view returns (address);
```

## âš ï¸ æ–°çš„æ½›åœ¨éŒ¯èª¤åŸå› 

### 1. æˆæ¬Šç›¸é—œéŒ¯èª¤
**éŒ¯èª¤è¨Šæ¯ï¼š** `"ERC20: insufficient allowance"`
- **åŸå› ï¼š** ç”¨æˆ¶æœªæˆæ¬ŠDungeonMasteråˆç´„ä½¿ç”¨å…¶SoulShardä»£å¹£
- **è§£æ±ºæ–¹æ¡ˆï¼š** èª¿ç”¨ `soulShardToken.approve(dungeonMasterAddress, amount)` æˆæ¬Š

### 2. é¤˜é¡ä¸è¶³éŒ¯èª¤
**éŒ¯èª¤è¨Šæ¯ï¼š** `"DM: Insufficient SoulShard balance"`
- **åŸå› ï¼š** ç”¨æˆ¶éŒ¢åŒ…ä¸­SoulShardä»£å¹£é¤˜é¡ä¸è¶³
- **è§£æ±ºæ–¹æ¡ˆï¼š** ç²å–æ›´å¤šSoulShardä»£å¹£

### 3. ä»£å¹£åˆç´„æœªè¨­ç½®
**éŒ¯èª¤è¨Šæ¯ï¼š** `"DM: SoulShard token not set"`
- **åŸå› ï¼š** DungeonCoreä¸­çš„soulShardTokenAddressæœªæ­£ç¢ºè¨­ç½®
- **è§£æ±ºæ–¹æ¡ˆï¼š** ç®¡ç†å“¡éœ€è¦æ­£ç¢ºè¨­ç½®ä»£å¹£åœ°å€

## ğŸ›¡ï¸ å‰ç«¯é›†æˆå»ºè­°

### è³¼è²·å‰æª¢æŸ¥å‡½æ•¸
```javascript
async function preCheckBuyProvisions(partyId, amount) {
    // 1. æª¢æŸ¥éšŠä¼æ“æœ‰æ¬Š
    const owner = await partyContract.ownerOf(partyId);
    if (owner.toLowerCase() !== userAddress.toLowerCase()) {
        throw new Error("æ‚¨ä¸æ˜¯æ­¤éšŠä¼çš„æ“æœ‰è€…");
    }
    
    // 2. è¨ˆç®—æˆæœ¬
    const costUSD = await dungeonMaster.provisionPriceUSD() * amount;
    const costSoulShard = await dungeonCore.getSoulShardAmountForUSD(costUSD);
    
    // 3. æª¢æŸ¥ç”¨æˆ¶é¤˜é¡
    const soulShardAddress = await dungeonCore.soulShardTokenAddress();
    const soulShardContract = new ethers.Contract(soulShardAddress, ERC20_ABI, provider);
    const balance = await soulShardContract.balanceOf(userAddress);
    
    if (balance < costSoulShard) {
        throw new Error(`SoulShardé¤˜é¡ä¸è¶³ã€‚éœ€è¦: ${ethers.utils.formatEther(costSoulShard)}, æ“æœ‰: ${ethers.utils.formatEther(balance)}`);
    }
    
    // 4. æª¢æŸ¥æˆæ¬Šé¡åº¦
    const allowance = await soulShardContract.allowance(userAddress, dungeonMasterAddress);
    if (allowance < costSoulShard) {
        throw new Error(`éœ€è¦å…ˆæˆæ¬ŠDungeonMasteråˆç´„ä½¿ç”¨æ‚¨çš„SoulShardä»£å¹£`);
    }
    
    return { costSoulShard, balance, allowance };
}
```

### æˆæ¬Šå‡½æ•¸
```javascript
async function approveSoulShard(amount) {
    const soulShardAddress = await dungeonCore.soulShardTokenAddress();
    const soulShardContract = new ethers.Contract(soulShardAddress, ERC20_ABI, signer);
    
    const tx = await soulShardContract.approve(dungeonMasterAddress, amount);
    await tx.wait();
    
    console.log("æˆæ¬Šå®Œæˆ");
}
```

### å®Œæ•´è³¼è²·æµç¨‹
```javascript
async function buyProvisions(partyId, amount) {
    try {
        // 1. å‰ç½®æª¢æŸ¥
        const { costSoulShard } = await preCheckBuyProvisions(partyId, amount);
        
        // 2. å¦‚æœéœ€è¦ï¼ŒåŸ·è¡Œæˆæ¬Š
        const soulShardAddress = await dungeonCore.soulShardTokenAddress();
        const soulShardContract = new ethers.Contract(soulShardAddress, ERC20_ABI, provider);
        const allowance = await soulShardContract.allowance(userAddress, dungeonMasterAddress);
        
        if (allowance < costSoulShard) {
            await approveSoulShard(costSoulShard);
        }
        
        // 3. åŸ·è¡Œè³¼è²·
        const tx = await dungeonMaster.buyProvisions(partyId, amount);
        await tx.wait();
        
        console.log("è³¼è²·æˆåŠŸï¼");
        
    } catch (error) {
        console.error("è³¼è²·å¤±æ•—:", error.message);
        throw error;
    }
}
```

## ğŸ“Š å„ªå‹¢èˆ‡æ³¨æ„äº‹é …

### âœ… å„ªå‹¢
1. **æ›´ç›´è§€** - ç”¨æˆ¶ç›´æ¥å¾éŒ¢åŒ…ä»˜æ¬¾ï¼Œä¸éœ€è¦é å…ˆå……å€¼é‡‘åº«
2. **æ¸›å°‘äº¤æ˜“æ­¥é©Ÿ** - ä¸€æ¬¡äº¤æ˜“å®Œæˆè³¼è²·
3. **æ›´éˆæ´»** - ç”¨æˆ¶å¯ä»¥é¸æ“‡æ€§åœ°é€²è¡ŒéŠæˆ²æ¶ˆè²»
4. **é™ä½è¤‡é›œåº¦** - æ¸›å°‘å°PlayerVaultçš„ä¾è³´

### âš ï¸ æ³¨æ„äº‹é …
1. **æˆæ¬Šéœ€æ±‚** - ç”¨æˆ¶é¦–æ¬¡ä½¿ç”¨æ™‚éœ€è¦æˆæ¬Šä»£å¹£ä½¿ç”¨æ¬Š
2. **Gasæˆæœ¬** - æ¯æ¬¡äº¤æ˜“éƒ½æ¶‰åŠä»£å¹£è½‰ç§»ï¼Œå¯èƒ½å¢åŠ Gasè²»ç”¨
3. **å®‰å…¨æ€§** - éœ€è¦ç¢ºä¿æˆæ¬Šé¡åº¦çš„å®‰å…¨ç®¡ç†
4. **ä¸€è‡´æ€§** - ç¢ºä¿æ‰€æœ‰éœ€è¦æ¶ˆè²»ä»£å¹£çš„åŠŸèƒ½éƒ½æ¡ç”¨ç›¸åŒçš„æ‰£æ¬¾æ–¹å¼

## ğŸ” æ¸¬è©¦å»ºè­°

### å–®å…ƒæ¸¬è©¦è¦†è“‹
1. æ­£å¸¸è³¼è²·æµç¨‹æ¸¬è©¦
2. é¤˜é¡ä¸è¶³æƒ…æ³æ¸¬è©¦
3. æˆæ¬Šä¸è¶³æƒ…æ³æ¸¬è©¦
4. ééšŠä¼æ“æœ‰è€…èª¿ç”¨æ¸¬è©¦
5. åˆç´„æš«åœç‹€æ…‹æ¸¬è©¦
6. Oracleåƒ¹æ ¼ç•°å¸¸æ¸¬è©¦

### é›†æˆæ¸¬è©¦
1. ç«¯åˆ°ç«¯è³¼è²·æµç¨‹
2. å¤šç”¨æˆ¶ä¸¦ç™¼è³¼è²·
3. å¤§é¡è³¼è²·æ¸¬è©¦
4. é‚Šç•Œæ¢ä»¶æ¸¬è©¦

é€™å€‹ä¿®æ”¹å¤§å¤§ç°¡åŒ–äº†ç”¨æˆ¶é«”é©—ï¼Œä½¿è³¼è²·å„²å‚™è®Šå¾—æ›´åŠ ç›´è§€å’Œä¾¿æ·ï¼