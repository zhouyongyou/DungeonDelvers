# 子圖同步問題診斷報告

## 🔍 問題概述
您的 Dungeon Delvers 子圖顯示同步失敗，需要進行全面診斷和修復。

## ✅ 已確認的正常狀態
1. **子圖代碼構建成功** - 代碼生成和編譯沒有錯誤
2. **BSC 網路狀態正常** - The Graph 官方狀態顯示 BSC 網路運行正常
3. **合約地址配置正確** - subgraph.yaml 中包含所有必要的合約地址

## 🚨 發現的潛在問題

### 1. 實體不存在警告
在子圖代碼中發現多個警告訊息：
- Hero、Relic、Party 轉移時實體不存在
- VIP 取消質押時實體不存在  
- Player Profile 不存在時添加經驗

### 2. 可能的根本原因

#### A. 區塊起始點問題
- 所有數據源都設置為相同的 `startBlock: 53534731`
- 可能某些合約實際部署在不同的區塊高度

#### B. 事件處理順序問題  
- Transfer 事件可能在 Mint 事件之前被處理
- 導致嘗試轉移尚未創建的實體

#### C. 網路或 RPC 連接問題
- BSC RPC 節點可能不穩定
- 數據獲取過程中可能出現間歇性失敗

## 🛠️ 建議的解決方案

### 立即檢查步驟

1. **檢查子圖部署狀態**
```bash
cd DDgraphql/dungeon-delvers
npx graph auth --product hosted-service [您的access-token]
npx graph status [您的子圖名稱]
```

2. **檢查合約部署區塊**
```bash
# 在您的前端應用中檢查每個合約的實際部署區塊
# 更新 subgraph.yaml 中的 startBlock
```

3. **重新部署子圖**
```bash
npm run sync-addresses  # 同步最新地址
npx graph build
npx graph deploy --node https://api.studio.thegraph.com/deploy/ dungeon-delvers
```

### 代碼修復建議

#### 1. 改進錯誤處理
在事件處理函數中添加更好的錯誤處理：

```typescript
// 在 src/hero.ts 中
export function handleTransfer(event: Transfer): void {
  let heroId = event.params.tokenId.toString()
  let hero = Hero.load(heroId)
  
  if (hero == null) {
    // 如果 Hero 不存在，嘗試創建或跳過
    log.warning("Transfer handled for a Hero that doesn't exist: {}, attempting to create", [heroId])
    // 可以選擇創建一個基本的 Hero 實體或跳過此事件
    return
  }
  
  // 繼續正常的轉移邏輯
}
```

#### 2. 檢查事件順序
確保 Mint 事件在 Transfer 事件之前處理，或者在 Transfer 處理函數中處理實體不存在的情況。

#### 3. 驗證起始區塊
檢查每個合約的實際部署區塊：

```javascript
// 添加到 scripts/verify-start-blocks.js
const contracts = {
  Hero: "0x2Cf5429dDbd2Df730a6668b50200233c76c1116F",
  Relic: "0x548eA33d0deC74bBE9a3F0D1B5E4C660bf59E5A5",
  // ... 其他合約
}

// 使用 web3 或 ethers 檢查每個合約的部署區塊
```

### 監控和調試

1. **啟用詳細日誌**
在 subgraph.yaml 中添加更多的日誌輸出

2. **設置健康檢查**
定期查詢子圖以確保數據同步正常

3. **檢查 The Graph 狀態**
監控 https://status.thegraph.com/ 上的 BSC 網路狀態

## 🔧 緊急修復步驟

如果需要立即恢復服務：

1. **回滾到上一個工作版本**
2. **使用較高的起始區塊重新部署**
3. **暫時禁用有問題的事件處理器**

## 📊 後續監控

部署修復後，請監控：
- 子圖同步進度
- 錯誤日誌數量
- 查詢響應時間
- 數據完整性

## 🔗 有用資源

- [The Graph 文檔](https://thegraph.com/docs/)
- [BSC 網路狀態](https://status.thegraph.com/)
- [子圖調試指南](https://thegraph.com/docs/en/debugging/)

---

**建議優先級：**
1. 🔥 檢查並修復起始區塊配置
2. 🔥 改進 Transfer 事件的錯誤處理
3. 📋 設置監控和警報
4. 📋 優化事件處理邏輯