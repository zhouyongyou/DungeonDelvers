# Dungeon Delvers ä¼ºæœå™¨è³‡æ–™èª¿ç”¨æ¶æ§‹åˆ†æ

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹æ¦‚è¦½

æ‚¨çš„ Dungeon Delvers é …ç›®æ¡ç”¨å¤šå±¤æ¶æ§‹ä¾†ç²å–å’Œè™•ç†è³‡æ–™ï¼š

```
å‰ç«¯ (React/Vite)
    â†“
â”œâ”€â”€ ç›´æ¥èª¿ç”¨æ™ºèƒ½åˆç´„ (Wagmi/Viem)
â”œâ”€â”€ èª¿ç”¨ Metadata Server API (Express.js)
â”œâ”€â”€ èª¿ç”¨ The Graph API (GraphQL)
â””â”€â”€ èª¿ç”¨ IPFS ç¶²é—œ (å…ƒæ•¸æ“šå’Œåœ–ç‰‡)
    â†“
å€å¡Šéˆ (BSC) + å­åœ– (The Graph)
```

## ğŸ” å…·é«”çš„ API ç«¯é»å¯¦ç¾ä½ç½®

### 1. `api/hero` ç­‰ API ç«¯é»ä½ç½®

**å¾Œç«¯å¯¦ç¾ä½ç½®**: `dungeon-delvers-metadata-server/src/index.js`

```javascript
// è‹±é›„ NFT å…ƒæ•¸æ“šç«¯é»
app.get('/api/hero/:tokenId', handleRequest(async (req, res) => {
    const { tokenId } = req.params;
    const cacheKey = `hero-${tokenId}`;
    const id = `${contractAddresses.hero.toLowerCase()}-${tokenId}`;

    const metadata = await withCache(cacheKey, async () => {
        // ä½¿ç”¨ DataLoader å¾ The Graph æ‰¹é‡æŸ¥è©¢
        const hero = await heroLoader.load(id);
        
        if (!hero) throw new Error(`Hero #${tokenId} not found in The Graph`);

        // ç”Ÿæˆå‹•æ…‹ SVG åœ–ç‰‡
        const svgString = generateHeroSVG({ rarity: hero.rarity, power: BigInt(hero.power) }, BigInt(tokenId));
        const image_data = Buffer.from(svgString).toString('base64');
        
        return {
            name: `Dungeon Delvers Hero #${tokenId}`,
            description: "A brave hero from the world of Dungeon Delvers, ready for adventure.",
            image: `data:image/svg+xml;base64,${image_data}`,
            attributes: [ 
                { trait_type: "Rarity", value: hero.rarity }, 
                { trait_type: "Power", value: Number(hero.power) },
                { trait_type: "Created At", value: Number(hero.createdAt), display_type: "date" }
            ],
        };
    }, 'hero');
    res.json(metadata);
}));
```

**æ‰€æœ‰ API ç«¯é»**:
- `GET /api/hero/:tokenId` - è‹±é›„ NFT å…ƒæ•¸æ“š
- `GET /api/relic/:tokenId` - è–ç‰© NFT å…ƒæ•¸æ“š  
- `GET /api/party/:tokenId` - éšŠä¼ NFT å…ƒæ•¸æ“š
- `GET /api/vip/:tokenId` - VIP NFT å…ƒæ•¸æ“š
- `GET /api/profile/:tokenId` - ç©å®¶æª”æ¡ˆ NFT å…ƒæ•¸æ“š
- `GET /health` - æœå‹™å¥åº·ç‹€æ…‹

### 2. å‰ç«¯ API èª¿ç”¨ä½ç½®

**æ ¸å¿ƒ API æ–‡ä»¶**: `src/api/nfts.ts`

```typescript
// å…ƒæ•¸æ“šç²å–å‡½æ•¸
export async function fetchMetadata(
    uri: string, 
    tokenId: string, 
    contractAddress: string, 
    retryCount = 0
): Promise<Omit<BaseNft, 'id' | 'contractAddress' | 'type'>> {
    
    // 1. å…ˆæª¢æŸ¥IndexedDBç·©å­˜
    const cachedMetadata = await nftMetadataCache.getMetadata(tokenId, contractAddress);
    if (cachedMetadata) {
        return cachedMetadata;
    }
    
    // 2. å¾ä¸åŒä¾†æºç²å–å…ƒæ•¸æ“š
    if (uri.startsWith('data:application/json;base64,')) {
        // ç›´æ¥è§£æ base64 ç·¨ç¢¼çš„å…ƒæ•¸æ“š
        const json = Buffer.from(uri.substring('data:application/json;base64,'.length), 'base64').toString();
        metadata = JSON.parse(json);
    } else if (uri.startsWith('ipfs://')) {
        // å¾ IPFS è¼‰å…¥å…ƒæ•¸æ“š
        const ipfsHash = uri.replace('ipfs://', '');
        const gateways = [
            `https://ipfs.io/ipfs/${ipfsHash}`,
            `https://gateway.pinata.cloud/ipfs/${ipfsHash}`,
            `https://cloudflare-ipfs.com/ipfs/${ipfsHash}`,
            `https://dweb.link/ipfs/${ipfsHash}`
        ];
        metadata = await fetchWithMultipleGateways(gateways, timeout);
    } else {
        // å¾ HTTP è¼‰å…¥å…ƒæ•¸æ“š
        metadata = await fetchWithTimeout(uri, timeout);
    }
    
    // 3. æˆåŠŸç²å–å¾Œç«‹å³ç·©å­˜
    await nftMetadataCache.cacheMetadata(tokenId, contractAddress, metadata);
    
    return metadata;
}
```

## ğŸ”„ å®Œæ•´çš„è³‡æ–™ç²å–æµç¨‹

### æµç¨‹ 1: NFT å…ƒæ•¸æ“šç²å–

```mermaid
graph TD
    A[å‰ç«¯çµ„ä»¶] --> B[èª¿ç”¨ fetchAllOwnedNfts]
    B --> C[æŸ¥è©¢ The Graph API]
    C --> D[ç²å– NFT åŸºæœ¬ä¿¡æ¯]
    D --> E[èª¿ç”¨æ™ºèƒ½åˆç´„ tokenURI]
    E --> F[ç²å–å…ƒæ•¸æ“š URI]
    F --> G{URI é¡å‹åˆ¤æ–·}
    G -->|base64| H[ç›´æ¥è§£æ JSON]
    G -->|ipfs://| I[ä¸¦è¡Œèª¿ç”¨å¤šå€‹ IPFS ç¶²é—œ]
    G -->|http://| J[èª¿ç”¨ Metadata Server API]
    H --> K[ç·©å­˜åˆ° IndexedDB]
    I --> K
    J --> K
    K --> L[è¿”å›å…ƒæ•¸æ“šçµ¦å‰ç«¯]
```

### æµç¨‹ 2: é é¢ç´šè³‡æ–™ç²å–

ä»¥ `ProfilePage.tsx` ç‚ºä¾‹:

```typescript
// 1. å‰ç«¯é é¢èª¿ç”¨
const response = await fetch(THE_GRAPH_API_URL, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ query: GET_PLAYER_PROFILE_QUERY })
})

// 2. GraphQL æŸ¥è©¢
const GET_PLAYER_PROFILE_QUERY = `
  query GetPlayerProfile($playerId: ID!) {
    player(id: $playerId) {
      profile {
        id
        tokenId
        level
        experience
      }
      heroes { id tokenId power rarity }
      relics { id tokenId capacity rarity }
      parties { id tokenId totalPower }
      vip { id tokenId stakedAmount level }
    }
  }
`;
```

## ğŸŒ è³‡æ–™ä¾†æºè©³ç´°åˆ†æ

### 1. The Graph API (GraphQL å­åœ–)
- **ä½ç½®**: `DDgraphql/` ç›®éŒ„
- **ç”¨é€”**: æŸ¥è©¢å€å¡Šéˆä¸Šçš„éŠæˆ²æ•¸æ“š
- **ç«¯é»**: `VITE_THE_GRAPH_STUDIO_API_URL`
- **æ•¸æ“šé¡å‹**: è‹±é›„ã€è–ç‰©ã€éšŠä¼ã€VIPã€ç©å®¶æª”æ¡ˆ

### 2. Metadata Server API (Express.js å¾Œç«¯)
- **ä½ç½®**: `dungeon-delvers-metadata-server/src/index.js`
- **ç”¨é€”**: NFT å…ƒæ•¸æ“šæœå‹™å’Œå‹•æ…‹ SVG ç”Ÿæˆ
- **ç«¯é»**: `http://localhost:3001` (é è¨­)
- **æŠ€è¡“æ£§**: Express.js + Redis ç·©å­˜ + DataLoader æ‰¹é‡æŸ¥è©¢

### 3. æ™ºèƒ½åˆç´„ç›´æ¥èª¿ç”¨
- **ä½ç½®**: å‰ç«¯é€šé Wagmi/Viem èª¿ç”¨
- **ç”¨é€”**: ç²å– tokenURIã€VIP ç­‰ç´šç­‰å¯¦æ™‚æ•¸æ“š
- **åˆç´„åœ°å€**: 
  - Hero: `VITE_MAINNET_HERO_ADDRESS`
  - Relic: `VITE_MAINNET_RELIC_ADDRESS`
  - Party: `VITE_MAINNET_PARTY_ADDRESS`
  - VIP: `VITE_MAINNET_VIPSTAKING_ADDRESS`

### 4. IPFS ç¶²é—œ
- **ç”¨é€”**: è¼‰å…¥ NFT åœ–ç‰‡å’Œå…ƒæ•¸æ“š
- **ç¶²é—œåˆ—è¡¨**:
  - `https://ipfs.io/ipfs/`
  - `https://gateway.pinata.cloud/ipfs/`
  - `https://cloudflare-ipfs.com/ipfs/`
  - `https://dweb.link/ipfs/`

## ğŸ¯ å…·é«”èª¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: ç²å–è‹±é›„ NFT å…ƒæ•¸æ“š

```typescript
// 1. å‰ç«¯èª¿ç”¨ (src/components/ui/NftCard.tsx)
const { data: tokenURI } = useReadContract({
  address: heroContractAddress,
  abi: heroAbi,
  functionName: 'tokenURI',
  args: [tokenId],
})

// 2. è§£æ tokenURI ä¸¦ç²å–å…ƒæ•¸æ“š
const metadata = await fetchMetadata(tokenURI, tokenId, contractAddress);

// 3. å¦‚æœ tokenURI æŒ‡å‘ metadata serverï¼Œæœƒèª¿ç”¨:
// GET http://localhost:3001/api/hero/123
```

### ç¤ºä¾‹ 2: ç²å–ç”¨æˆ¶æ‰€æœ‰ NFT

```typescript
// 1. å‰ç«¯èª¿ç”¨ (src/pages/MyAssetsPage.tsx)
const { data: nfts } = useQuery({
  queryKey: ['userNfts', address, chainId],
  queryFn: () => fetchAllOwnedNfts(address!, chainId),
})

// 2. å…§éƒ¨æŸ¥è©¢ The Graph API
const response = await fetch(THE_GRAPH_API_URL, {
  method: 'POST',
  body: JSON.stringify({
    query: GET_PLAYER_ASSETS_QUERY,
    variables: { owner: address.toLowerCase() }
  })
});

// 3. æ‰¹é‡ç²å–æ¯å€‹ NFT çš„å…ƒæ•¸æ“š
const results = await batchProcess(assets, async (asset) => {
  const metadata = await fetchMetadata(asset.tokenURI, asset.tokenId, contractAddress);
  return { ...asset, ...metadata };
});
```

## ğŸš€ æ€§èƒ½å„ªåŒ–ç­–ç•¥

### 1. å¤šç´šç·©å­˜ç³»çµ±
- **IndexedDB**: å‰ç«¯æœ¬åœ°ç·©å­˜ (src/cache/)
- **Redis**: å¾Œç«¯ metadata server ç·©å­˜
- **Apollo Client**: GraphQL æŸ¥è©¢ç·©å­˜
- **React Query**: REST API æ•¸æ“šç·©å­˜

### 2. ä¸¦è¡Œè«‹æ±‚å„ªåŒ–
- **å¤šå€‹ IPFS ç¶²é—œä¸¦è¡Œ**: åŒæ™‚è«‹æ±‚å¤šå€‹ç¶²é—œï¼Œä½¿ç”¨æœ€å¿«çš„
- **æ‰¹é‡è™•ç†**: é™åˆ¶ä¸¦ç™¼è«‹æ±‚æ•¸é‡ï¼Œé¿å…éè¼‰
- **DataLoader**: å¾Œç«¯æ‰¹é‡æŸ¥è©¢ï¼Œæ¸›å°‘ GraphQL è«‹æ±‚

### 3. éŒ¯èª¤è™•ç†å’Œé‡è©¦
- **æŒ‡æ•¸å›é€€é‡è©¦**: å¤±æ•—å¾Œé€æ¼¸å¢åŠ é‡è©¦é–“éš”
- **é™ç´šç­–ç•¥**: å¤±æ•—æ™‚è¿”å› fallback æ•¸æ“š
- **è¶…æ™‚è¨­ç½®**: æ¼¸é€²å¼å¢åŠ è¶…æ™‚æ™‚é–“

## ğŸ”§ ç’°å¢ƒé…ç½®

### å¿…è¦çš„ç’°å¢ƒè®Šæ•¸

```bash
# GraphQL API
VITE_THE_GRAPH_STUDIO_API_URL=https://api.studio.thegraph.com/...

# æ™ºèƒ½åˆç´„åœ°å€
VITE_MAINNET_HERO_ADDRESS=0x...
VITE_MAINNET_RELIC_ADDRESS=0x...
VITE_MAINNET_PARTY_ADDRESS=0x...
VITE_MAINNET_VIPSTAKING_ADDRESS=0x...

# RPC ç«¯é»
VITE_ALCHEMY_BSC_MAINNET_RPC_URL=https://...
VITE_INFURA_BSC_MAINNET_RPC_URL=https://...
```

## ğŸ“Š ç›£æ§å’Œè¨ºæ–·

### 1. å¥åº·æª¢æŸ¥ç«¯é»
```http
GET /health
```

### 2. ç·©å­˜çµ±è¨ˆ
```http
GET /admin/cache/stats
```

### 3. æ€§èƒ½æŒ‡æ¨™
```http
GET /admin/metrics
```

## ğŸ® ç¸½çµ

æ‚¨çš„ Dungeon Delvers é …ç›®ä½¿ç”¨äº†ä¸€å€‹é«˜åº¦å„ªåŒ–çš„å¤šå±¤æ¶æ§‹ä¾†ç²å–è³‡æ–™ï¼š

1. **å‰ç«¯**: React çµ„ä»¶é€šé Wagmi/Viem èª¿ç”¨æ™ºèƒ½åˆç´„ï¼Œé€šé Apollo Client æŸ¥è©¢ The Graph
2. **å¾Œç«¯**: Express.js metadata server æä¾› NFT å…ƒæ•¸æ“š APIï¼Œé›†æˆ Redis ç·©å­˜
3. **å€å¡Šéˆ**: BSC æ™ºèƒ½åˆç´„å­˜å„²æ ¸å¿ƒæ•¸æ“š
4. **å­åœ–**: The Graph ç´¢å¼•å€å¡Šéˆæ•¸æ“šï¼Œæä¾› GraphQL API
5. **IPFS**: åˆ†æ•£å¼å­˜å„² NFT å…ƒæ•¸æ“šå’Œåœ–ç‰‡

é€™å€‹æ¶æ§‹ç¢ºä¿äº†é«˜æ€§èƒ½ã€é«˜å¯ç”¨æ€§å’Œè‰¯å¥½çš„ç”¨æˆ¶é«”é©—ï¼ŒåŒæ™‚é€šéå¤šç´šç·©å­˜å’Œä¸¦è¡Œè«‹æ±‚å„ªåŒ–äº†è¼‰å…¥é€Ÿåº¦ã€‚