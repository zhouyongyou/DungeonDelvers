# 🚀 鑄造頁面樂觀授權更新指南

## 功能概述

實施了**樂觀更新**機制，大幅提升鑄造頁面的用戶體驗。用戶完成授權後，**無需等待鏈上確認**，可立即看到「招募」按鈕並開始鑄造。

## 🎯 解決的問題

**之前的問題：**
- 授權完成後需要等待 1.5 秒 × 5 次 = 最長 7.5 秒
- 用戶看到「檢查授權狀態...」提示，體驗差
- 明明授權已經成功，卻無法立即鑄造

**現在的體驗：**
- 授權完成後 **立即** 顯示招募按鈕
- 按鈕文字變為 `招募 X 個 ⚡` 表示樂觀更新
- 2-3 秒後自動變為正常招募按鈕

## 🔧 技術實現

### 1. 樂觀狀態管理
```typescript
// 新增樂觀授權狀態
const [optimisticApprovalGranted, setOptimisticApprovalGranted] = useState(false);

// 合併實際狀態與樂觀狀態
const needsApproval = baseNeedsApproval && !optimisticApprovalGranted;
```

### 2. 授權成功立即更新
```typescript
onSuccess: async () => {
    showToast('授權完成！可以開始鑄造了 ⚡', 'success');
    
    // 🚀 樂觀更新：立即認為授權成功
    setOptimisticApprovalGranted(true);
    setIsCheckingApproval(false);
    
    // 背景更新實際授權狀態（不阻塞 UI）
    setTimeout(async () => {
        await refetchAllowance();
    }, 500);
}
```

### 3. 智能狀態重置
```typescript
// 當支付方式改變時重置
useEffect(() => {
    if (paymentSource === 'vault') {
        setOptimisticApprovalGranted(false);
    }
}, [paymentSource]);

// 當實際授權足夠時重置
useEffect(() => {
    if (allowance && requiredAmount && allowance >= requiredAmount) {
        setOptimisticApprovalGranted(false);
    }
}, [allowance, requiredAmount]);
```

## 📱 用戶體驗流程

1. **用戶點擊「授權代幣使用」**
   - 顯示交易進度彈窗
   - MetaMask 彈出授權確認

2. **用戶確認授權交易**
   - 交易提交到鏈上
   - 進度彈窗顯示「等待確認...」

3. **授權交易確認** 🚀
   - **立即**關閉進度彈窗
   - **立即**顯示「授權完成！可以開始鑄造了 ⚡」
   - **立即**按鈕變為「招募 X 個 ⚡」
   - 用戶可以立即點擊開始鑄造

4. **背景同步**（不影響用戶）
   - 500ms 後在背景更新授權狀態
   - 2.5 秒後再次檢查確保同步
   - 閃電符號 ⚡ 逐漸消失，變為正常按鈕

## 🛡️ 安全性保障

### 防止重複授權
- 樂觀狀態會在支付方式改變時重置
- 實際授權足夠時會自動重置樂觀狀態
- 不會影響實際的鏈上授權檢查

### 容錯機制
- 如果背景同步失敗，不影響用戶操作
- 實際鑄造時仍會檢查真實授權狀態
- MetaMask 會在授權不足時阻止交易

## 🎨 視覺反饋

| 狀態 | 按鈕文字 | 說明 |
|------|----------|------|
| 未授權 | `授權代幣使用` | 需要用戶授權 |
| 授權中 | `處理中...` | 交易進行中 |
| 樂觀已授權 | `招募 X 個 ⚡` | 可以立即鑄造 |
| 實際已授權 | `招募 X 個` | 正常狀態 |

## 🧪 測試建議

1. **正常授權流程**
   - 連接錢包 → 選擇數量 → 點擊授權 → 確認授權 → 立即看到招募按鈕

2. **切換支付方式**
   - 授權後切換到金庫支付 → 樂觀狀態重置
   - 切換回錢包支付 → 如果實際授權足夠，直接顯示招募按鈕

3. **增加數量**
   - 授權 10 個後改為 100 個 → 如果授權不足會重新要求授權

## 💡 預期效果

- **等待時間**：從 7.5 秒降至 0 秒
- **用戶滿意度**：立即反饋提升體驗
- **操作流暢度**：授權 → 鑄造一氣呵成
- **視覺提示**：⚡ 符號表示快速更新狀態

這個樂觀更新機制讓鑄造流程更加順暢，用戶不再需要等待「檢查授權狀態」的漫長過程！