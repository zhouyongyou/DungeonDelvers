# 錢包授權修正建議

## 🔍 當前狀況分析

### 已完成的後端修改
根據系統報告，購買儲備流程已經從「PlayerVault金庫扣款」改為「錢包直接扣款」，這需要前端相應的修改：

1. **合約層面**：`buyProvisions()` 現在使用 `safeTransferFrom` 直接從用戶錢包扣款
2. **授權要求**：用戶首次購買前必須授權 DungeonMaster 合約使用其 SoulShard 代幣

### 前端當前狀況
✅ **已實作的功能**：
- ProvisionsPage.tsx 已有完整的授權檢查和授權按鈕
- 授權流程已經正常運作
- 錯誤處理機制已到位

❌ **需要修正的問題**：
1. **支付方式選擇已過時**：仍保留「錢包支付 vs 金庫支付」選項，但合約只支援錢包扣款
2. **用戶體驗不一致**：DungeonPage 中的快速購買按鈕未處理授權流程
3. **界面提示需更新**：「金庫支付 (免稅)」選項已無效

## 🛠️ 必要修正項目

### 1. 簡化 ProvisionsPage.tsx
```typescript
// 移除 paymentSource 狀態和相關UI
// 當前程式碼有：
const [paymentSource, setPaymentSource] = useState<PaymentSource>('wallet');

// 應該簡化為只使用錢包餘額
const { data: walletBalance } = useBalance({ address, token: soulShardContract?.address });
```

### 2. 更新授權檢查邏輯
```typescript
// 簡化授權檢查，移除 paymentSource 條件
const needsApproval = useMemo(() => {
    if (typeof allowance !== 'bigint' || typeof requiredAmount !== 'bigint') return false;
    return allowance < requiredAmount;
}, [allowance, requiredAmount]);
```

### 3. 統一錯誤處理
需要在各個購買入口點都加入相同的授權檢查：
- ProvisionsPage（已完成）
- DungeonPage 的快速購買按鈕（需要修正）
- 其他可能的購買入口

## 📋 詳細修改清單

### A. ProvisionsPage.tsx 修改
1. **移除支付方式選擇器**
   - 刪除 `PaymentSource` 類型和相關狀態
   - 移除支付方式切換按鈕組
   - 移除「金庫餘額」顯示

2. **簡化餘額檢查**
   - 只檢查錢包 SoulShard 餘額
   - 移除金庫餘額相關邏輯

3. **更新 UI 文案**
   - 移除「(免稅)」等過時提示
   - 更新錯誤訊息

### B. DungeonPage.tsx 增強
1. **增加授權檢查**
   - 在快速購買按鈕點擊時檢查授權狀態
   - 如未授權，先引導用戶完成授權

2. **改善用戶體驗**
   - 顯示授權狀態提示
   - 提供一鍵授權功能

### C. 通用改進
1. **創建共用 Hook**
   ```typescript
   // useTokenAuthorization.ts
   export const useTokenAuthorization = (
     tokenContract: any, 
     spenderContract: any, 
     requiredAmount: bigint
   ) => {
     // 統一處理授權邏輯
   }
   ```

2. **錯誤提示優化**
   - 授權失敗時提供明確指引
   - 餘額不足時建議獲取代幣的方式

## 🎯 推薦修改順序

### 第一步：修正 ProvisionsPage.tsx
- **優先級：高**
- **影響：修正主要購買流程**

### 第二步：統一 DungeonPage.tsx
- **優先級：中**
- **影響：改善快速購買體驗**

### 第三步：創建共用組件
- **優先級：低**
- **影響：提升代碼複用性**

## 💡 用戶體驗建議

### 授權流程優化
1. **首次購買時**：
   - 明確告知需要授權
   - 說明授權的安全性和必要性
   - 提供「授權 + 購買」一鍵操作

2. **授權完成後**：
   - 顯示授權成功提示
   - 自動進入購買流程
   - 記錄授權狀態避免重複檢查

3. **錯誤處理**：
   - 授權被拒絕：提供重試選項
   - 餘額不足：引導到獲取代幣頁面
   - 網路錯誤：提供重新連接指引

## 🔒 安全考量

### 授權額度管理
```typescript
// 建議使用 maxUint256 進行無限授權，避免每次購買都需要重新授權
const approveAmount = maxUint256; // 而不是具體數額

// 或者提供選項讓用戶選擇授權方式
const [approvalType, setApprovalType] = useState<'unlimited' | 'exact'>('unlimited');
```

### 交易安全
- 購買前再次確認價格和數量
- 顯示預計 Gas 費用
- 提供交易取消機制

## 📊 測試檢查清單

### 功能測試
- [ ] 首次用戶：授權 → 購買流程
- [ ] 已授權用戶：直接購買流程  
- [ ] 授權被拒絕的處理
- [ ] 餘額不足的處理
- [ ] 網路錯誤的處理

### UI/UX 測試
- [ ] 授權按鈕狀態正確
- [ ] 載入狀態顯示適當
- [ ] 錯誤訊息清楚明確
- [ ] 成功提示及時顯示

---

**總結**：目前的授權功能基本完善，主要需要移除過時的支付方式選擇，並統一各個購買入口的授權處理邏輯。這將大大改善用戶體驗，讓購買儲備流程更加直觀簡潔。