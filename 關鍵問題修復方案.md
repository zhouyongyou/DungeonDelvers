# 關鍵問題修復方案

## 🚨 立即需要修復的錯誤

### 1. DungeonPage.tsx - React Hooks 條件式調用錯誤

**問題位置**: 第234-249行
**錯誤**: 在條件語句內調用React Hooks，違反了Hooks規則

**當前問題代碼**:
```typescript
// 僅支援主網
if (chainId !== bsc.id) {
    return <div className="flex justify-center items-center h-64"><p className="text-lg text-gray-500">請連接到支援的網路</p></div>;
}

const dungeonMasterContract = getContract(bsc.id, 'dungeonMaster');
const { writeContractAsync, isPending: isTxPending } = useWriteContract(); // ❌ 條件式調用Hook

// ★ 核心改造：使用新的 Hook 獲取隊伍數據
const { data: parties, isLoading: isLoadingParties } = usePlayerParties(); // ❌ 條件式調用Hook

// 獲取地城資訊的邏輯保持不變，因為這是全域數據
const { data: dungeonsData, isLoading: isLoadingDungeons } = useReadContracts({ // ❌ 條件式調用Hook
```

**修復方案**:
```typescript
const DungeonPage: React.FC<{ setActivePage: (page: Page) => void; }> = ({ setActivePage }) => {
    const { chainId } = useAccount();
    const { showToast } = useAppToast();
    const { addTransaction, transactions } = useTransactionStore();

    // ✅ 將所有Hooks調用移到組件頂部，在任何條件語句之前
    const dungeonMasterContract = getContract(bsc.id, 'dungeonMaster');
    const { writeContractAsync, isPending: isTxPending } = useWriteContract();
    const { data: parties, isLoading: isLoadingParties } = usePlayerParties();
    const { data: dungeonsData, isLoading: isLoadingDungeons } = useReadContracts({
        contracts: Array.from({ length: 10 }, (_, i) => ({
            ...getContract(bsc.id, 'dungeonStorage'),
            functionName: 'getDungeon',
            args: [BigInt(i + 1)],
        })),
        query: { enabled: !!getContract(bsc.id, 'dungeonStorage') && chainId === bsc.id }
    });

    const [isProvisionModalOpen, setIsProvisionModalOpen] = useState(false);
    const [selectedPartyForProvision, setSelectedPartyForProvision] = useState<bigint | null>(null);

    // ✅ 條件渲染移到所有Hooks之後
    if (chainId !== bsc.id) {
        return <div className="flex justify-center items-center h-64"><p className="text-lg text-gray-500">請連接到支援的網路</p></div>;
    }

    // 其餘邏輯保持不變...
```

### 2. VipPage.tsx - React Hooks 條件式調用錯誤

**問題位置**: 第17-28行
**錯誤**: 在條件語句內調用React Hooks

**當前問題代碼**:
```typescript
const VipCardDisplay: React.FC<{ tokenId: bigint | null, chainId: number | undefined }> = ({ tokenId, chainId }) => {
    if (!chainId || (chainId !== bsc.id)) {
        return <div className="w-full aspect-square bg-gray-900/50 rounded-xl flex items-center justify-center text-gray-500">網路不支援</div>;
    }
    const vipStakingContract = getContract(chainId as any, 'vipStaking');
    
    const { data: tokenURI, isLoading, isError } = useReadContract({ // ❌ 條件式調用Hook
```

**修復方案**:
```typescript
const VipCardDisplay: React.FC<{ tokenId: bigint | null, chainId: number | undefined }> = ({ tokenId, chainId }) => {
    // ✅ 將Hook調用移到組件頂部
    const vipStakingContract = getContract(chainId as any, 'vipStaking');
    
    const { data: tokenURI, isLoading, isError } = useReadContract({
        ...vipStakingContract,
        functionName: 'tokenURI',
        args: [tokenId!],
        query: { 
            enabled: !!tokenId && 
                     tokenId > 0n && 
                     !!vipStakingContract && 
                     !!chainId && 
                     chainId === bsc.id 
        },
    });

    // ✅ 條件渲染移到Hook之後
    if (!chainId || (chainId !== bsc.id)) {
        return <div className="w-full aspect-square bg-gray-900/50 rounded-xl flex items-center justify-center text-gray-500">網路不支援</div>;
    }

    // 其餘邏輯保持不變...
```

### 3. NftCard.tsx - Switch Case 聲明錯誤

**問題位置**: 第33, 41, 49, 62行
**錯誤**: 在switch case中直接聲明變量，需要用大括號包圍

**當前問題代碼**:
```typescript
switch (nft.type) {
  case 'hero':
    const hero = nft as HeroNft; // ❌ 需要大括號
    return (
      <>
        <StarRating rating={hero.rarity} />
        <p className="text-lg font-bold text-indigo-400">{hero.power.toString()} MP</p>
      </>
    );
  case 'relic':
    const relic = nft as RelicNft; // ❌ 需要大括號
```

**修復方案**:
```typescript
switch (nft.type) {
  case 'hero': {  // ✅ 添加大括號
    const hero = nft as HeroNft;
    return (
      <>
        <StarRating rating={hero.rarity} />
        <p className="text-lg font-bold text-indigo-400">{hero.power.toString()} MP</p>
      </>
    );
  }
  case 'relic': {  // ✅ 添加大括號
    const relic = nft as RelicNft;
    return (
      <>
        <StarRating rating={relic.rarity} />
        <p className="text-lg font-bold text-teal-400">容量: {relic.capacity}</p>
      </>
    );
  }
  case 'party': {  // ✅ 添加大括號
    const party = nft as PartyNft;
    return (
      <>
        <StarRating rating={party.partyRarity} />
        <div className="text-xs text-gray-400 flex justify-center items-center gap-2">
            <span>英雄: {party.heroIds.length}</span>
            <span>/</span>
            <span>聖物: {party.relicIds.length}</span>
        </div>
        <p className="text-lg font-bold mt-1 text-green-400">{party.totalPower.toString()} MP</p>
      </>
    );
  }
  case 'vip': {  // ✅ 添加大括號
    const vip = nft as VipNft;
    return (
        <>
            <StarRating rating={5} /> 
            <p className="text-lg font-bold text-yellow-300">等級 {vip.level}</p>
        </>
    );
  }
  default:
    return null;
}
```

## 🔧 執行修復的順序

1. **立即修復**: 先修復上述3個關鍵的React Hooks和語法錯誤
2. **測試驗證**: 修復後運行 `npm run lint` 確認錯誤減少
3. **逐步清理**: 再處理其他any類型和未使用變量的問題

## 📝 修復後預期結果

修復這3個關鍵問題後，錯誤數量將從79個減少到約65-70個，主要剩餘的將是：
- TypeScript any類型警告（不影響運行）
- 未使用變量警告（不影響運行）  
- React依賴項警告（不影響運行）

這些修復將解決所有可能阻止項目正常運行的關鍵錯誤。